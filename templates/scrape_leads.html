{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Web Scrape Leads</h1>

    <div class="card mb-4">
        <div class="card-header">
            Scrape New Leads
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('scrape_leads_route') }}">
                {{ form.csrf_token }}
                <div class="mb-3">
                    {{ form.url.label(class="form-label") }}
                    {{ form.url(class="form-control", placeholder=form.url.render_kw['placeholder']) }}
                    {% for error in form.url.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> {{ form.submit.label }}
                </button>
            </form>
        </div>
    </div>

    {% if scraped_leads %}
    <div class="card mt-4">
        <div class="card-header">
            Scraped Leads ({{ scraped_leads|length }})
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('add_scraped_leads') }}">
                {{ csrf_token }}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="select-all-leads" aria-label="Select all leads">
                                </th>
                                <th>Username</th>
                                <th>Platform</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Profile URL</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lead in scraped_leads %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="selected_leads" value="{{ loop.index0 }}" aria-label="Select lead {{ loop.index0 + 1 }}">
                                </td>
                                <td>{{ lead.username | default('N/A') }}</td>
                                <td>{{ lead.platform | default('N/A') }}</td>
                                <td>{{ lead.full_name | default('N/A') }}</td>
                                <td>{{ lead.email | default('N/A') }}</td>
                                <td>
                                    {% if lead.profile_url %}
                                        <a href="{{ lead.profile_url }}" target="_blank">{{ lead.profile_url }}</a>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <button type="submit" class="btn btn-success mt-3">
                    <i class="fas fa-plus-circle"></i> Add Selected Leads to Database
                </button>
            </form>
        </div>
    </div>
    {% elif request.method == 'POST' %}
    <div class="alert alert-info mt-4" role="alert">
        No leads found for the provided URL.
    </div>
    {% endif %}
</div>

<script>
    document.getElementById('select-all-leads').onclick = function() {
        var checkboxes = document.querySelectorAll('input[name="selected_leads"]');
        for (var checkbox of checkboxes) {
            checkbox.checked = this.checked;
        }
    }
</script>
{% endblock %}